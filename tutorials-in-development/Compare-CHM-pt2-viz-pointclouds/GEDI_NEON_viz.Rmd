---
syncID:
title: "Matching GEDI waveforms with NEON AOP LiDAR pointclouds"
description: "GEDI has amazing coverage around the globe, but is limited in its spatial resolution. Here, we extract NEON pointcloud data corresponding to individual GEDI waveforms to better understand how the GEDI return waveform gets its shape."
dateCreated: 2020-07-15
authors: Donal O'Leary
contributors: 
estimatedTime: 1 hour
packagesLibraries: lidR, rGEDI, raster
topics: LiDAR
languagesTool: R
dataProduct: 
code1: 
tutorialSeries: 
urlTitle: 
---

<div id="ds-objectives" markdown="1">

## Learning Objectives 
After completing this tutorial you will be able to: 

* Search for GEDI data based on a NEON site bounding box
* Extract NEON LiDAR pointcloud data corresponding to a specific GEDI footprint
* Visualize NEON and GEDI LiDAR data together in 3D

## Things You’ll Need To Complete This Tutorial

### R Programming Language
You will need a current version of R to complete this tutorial. We also recommend 
the RStudio IDE to work with R. 

### R Packages to Install
Prior to starting the tutorial ensure that the following packages are installed. 
* **raster:** `install.packages("raster")`
* **rgdal:** `install.packages("rGEDI")`
* **sp:** `install.packages("sp")`
* **sf:** `install.packages("sf")`
* **lidR:** `install.packages("lidR")`

########## add more packages here as needed #######

<a href="/packages-in-r" target="_blank"> More on Packages in R </a>– Adapted from Software Carpentry.

### Example Data Set

############# Possibly add GEDI subset here?? ##############

#### NEON Teaching Data Subset: Plant Phenology & Single Aspirated Air Temperature

The data used in this tutorial were collected at the 
<a href="http://www.neonscience.org" target="_blank"> National Ecological Observatory Network's</a> 
<a href="/field-sites/field-sites-map" target="_blank"> Domain 02 field sites</a>.  

* National Ecological Observatory Network. 2020. Data Product DP1.10055.001, Plant phenology observations. Provisional data downloaded from http://data.neonscience.org on February 5, 2020. Battelle, Boulder, CO, USA NEON. 2020.
* National Ecological Observatory Network. 2020. Data Product DP1.00002.001, Single aspirated air temperature. Provisional data downloaded from http://data.neonscience.org on February 5, 2020. Battelle, Boulder, CO, USA NEON. 2020.

<a href="https://ndownloader.figshare.com/files/9012085" class="link--button link--arrow">
Download Dataset</a>

### Working Directory
[Donal to add text]

</div>

## Getting Started
In this tutorial, we will compare NEON and GEDI LiDAR data by comparing the information that they both capture in the same location. NEON data are actually one of the datasets used by the GEDI mission to calibrate and validate GEDI waveforms, so this makes for a valuable comparison! In order to compare these data, we will need to download GEDI data that overlap a NEON site. However, GEDI data are currently only available to download per complete orbit, which means that the vast majority of the orbit's data does not fall within a NEON site. The GEDI orbit datasets come in HDF5 data format, and contain about 7Gb of data, so you may want to run the first few sections of this tutorial to get the GEDI download started, and refresh your memory of HDF5 files with our <a href="https://www.neonscience.org/intro-hdf5-r-series">Intro to HDF5 series</a>.

First, we will load the required libraries and set our working directory:

```{r load-libraries}

library(rGEDI)
library(raster)
library(sf)
library(rgl)
library(lidR)
library(neonUtilities)
library(viridis)

wd <- "~/Downloads/" # This will depend on your local environment
setwd(wd)

```

Next, we will download a Canopy Height Model (CHM) tile from the Wind River Experiemental Forest (WREF) using the `byTileAOP()` function to use as a preliminary map on which to overlay the GEDI data. There is one particularly interesting mosaic tile which we will select using the `easting` and `northing` arguments. We then load the raster into R and make a simple plot. For more information about CHMs, please see our tutorial <a href="https://www.neonscience.org/chm-dsm-dtm-gridded-lidar-data">What is a CHM?</a>

```{r download-chm}

# Define the SITECODE as a variable because
# we will use it several times in this tutorial
SITECODE <- "WREF"

byTileAOP(dpID = "DP3.30015.001", site = SITECODE, year = 2017, 
          easting = 580000, northing = 5075000, check.size = F,
          savepath = wd)

chm <- raster(paste0(wd, "/DP3.30015.001/2017/FullSite/D16/2017_WREF_1/L3/DiscreteLidar/CanopyHeightModelGtif/NEON_D16_WREF_DP3_580000_5075000_CHM.tif"))

plot(chm)

```

As you can see, this particular CHM is showing a conspicuous, triangle-shaped clearcut in this section of the experimental forest, where the tree canopy is much shorter than the towering 60m+ trees in the undisturbed areas. This variation will give us a variety of forest structures to investigate.





## Aligning the Vertical Datum

 --- needs information on geoid vs sphereoid ---
 
AOP data are delivered with the coordinate reference system (CRS) in the UTM zone in which they were collected, set to the `GEOID12A` vertical datum (roughly matched mean sea level). Meanwhile, GEDI data are delivered with the common `WGS84` ellipsoidal refrence datum. We need to align these vertical datums to ensure that the two data products line up correctly. However, this is not a trivial step, nor as simple as a reprojection.

NOAA has a useful tool called Vdatum that will convert from one datum to another. Unfortunately, it cannot convert from GEOID12A to WGS84 directly. We must first convert from GEOID12A to NAD83, then use a simpler method to adjust for the offset between the NAD83 and WGS84 datums. 


When converting from NAD83 to ITRF2000

diff tiff comes from Vdatum

GEOID12A to NAD83 interactive page found here: https://www.ngs.noaa.gov/cgi-bin/GEOID_STUFF/geoid12A_prompt1.prl

Download raster tiles of diff between GEOID12A and NAD83 here:
https://www.ngs.noaa.gov/GEOID/GEOID12A/GEOID12A_CONUS.shtml

```{r}

# Download binary file of offset from GEOID12A to NAD83
download.file("https://www.ngs.noaa.gov/PC_PROD/GEOID12A/Format_unix/g2012au0.bin", 
              destfile = paste0(wd,"/g2012au0.bin"))




# Read header information. See https://www.ngs.noaa.gov/GEOID/GEOID12B/g2012Brme.txt

# File Structure
# ---------------
# The files (ASCII and binary) follow the same structure of a one-line header 
# followed by the data in row-major format. The one-line header contains four 
# double (real*8) words followed by three long (int*4) words. 
# These parameters define the geographic extent of the area:
# 
# SLAT:  Southernmost North latitude in whole degrees. 
#        Use a minus sign (-) to indicate South latitudes. 
# WLON:  Westernmost East longitude in whole degrees. 
# DLAT:  Distance interval in latitude in whole degrees 
#        (point spacing in E-W direction)
# DLON:  Distance interval in longitude in whole degrees 
#        (point spacing in N-S direction)
# NLAT:  Number of rows 
#        (starts with SLAT and moves northward DLAT to next row)
# NLON:  Number of columns 
#        (starts with WLON and moves eastward DLON to next column)
# IKIND: Always equal to one (indicates data are real*4 and endian condition)

to.read = file("~/Downloads/g2012au0.bin", "rb")
header1=readBin(to.read, double(), endian = "big", n=4)
header1

header2=readBin(to.read, integer(), endian = "big", n=3)
header2

GEOID12A_diff_vals=readBin(to.read, n=header2[1]*header2[2], numeric(), endian = "big", size=4)

```

```{r make-GEOID12A-diff_raster, fig.height=8, fig.width=6}

GEOID12A_diff_rast <- raster(ncol=header2[2], nrow=header2[1], 
                             xmn=header1[2]-360, xmx=header1[2]+(header1[4]*header2[2])-360, 
                             ymn=header1[1], ymx=header1[1]+(header1[3]*header2[1]))
GEOID12A_diff_rast <- setValues(GEOID12A_diff_rast, values = GEOID12A_diff_vals)

# we need to use the 'flip' function to put the map 'upright' because R expects to see raster values from the top left corner and fills by rows, but this dataset is delivered in sucha a way that it describes the bottom left corner and fills by rows up to the top of the image (this is actually the convention for most traditional remote sensing software - and leads to a similar problem that is explained in the Hyperspectral tutorial series.)
GEOID12A_diff_rast <- flip(GEOID12A_diff_rast, 'y')

## let's crop out only CONUS for plotting purposes - we will still refer to the fill image when extracting values.

diff_resp=resample(diff, GEOID12A_diff_rast) # resample to match pixel size/registration for cropping
diff_resp=crop(diff_resp, GEOID12A_diff_rast)
GEOID12A_diff_rast=crop(GEOID12A_diff_rast, extent(diff_resp))
GEOID12A_diff_rast_mask=mask(GEOID12A_diff_rast, diff_resp)
par(mfrow=c(2,1), mar=c(2.5,2.5, 3.5,1))
plot(GEOID12A_diff_rast_mask, col=viridis(100),main="GEOID12A minus NAD83 (m)")
plot(diff, main="WGS84 minus NAD83 (m)")

```

Use extract() function to retrieve values from both rasters for a given GEDI footprint

```{r extract-vert-offsets}

WGS_NAD_diff <- extract(diff, as.data.frame(level1bgeo_WREF[,c(3,2)]))

GEOID12A_NAD_diff <- extract(GEOID12A_diff_rast_mask, as.data.frame(level1bgeo_WREF[,c(3,2)]))

## GEDI elevation is in WGS84, so to concert to NAD83 first subtract WGS_NAD_diff

## Next, to convert GEDI elevations fron NAD83 to GEOID12A, add GEOID12A_NAD_diff (which makes it lower because GEOID12A is lower than NAD83 in N America)

## Check to see if AOP forest floor and GEDI ground spike coincide. 

```